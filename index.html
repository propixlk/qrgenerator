<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>දියුණු QR කේත උත්පාදකය</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QRCode.js library CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script>
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right, #6a11cb 0%, #2575fc 100%); /* Blue-purple gradient background */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1.5rem; /* Equivalent to p-6 */
        }
        .container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* Equivalent to rounded-3xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* Equivalent to shadow-xl */
            width: 100%;
            max-width: 32rem; /* Equivalent to max-w-xl */
            padding: 2.5rem; /* Equivalent to p-10 */
        }
        /* Custom styles for the QR code canvas */
        #qrcode canvas {
            display: block;
            margin: 0 auto;
            border-radius: 0.75rem; /* Apply rounded corners to the canvas */
            transition: transform 0.3s ease-in-out;
        }
        #qrcode canvas:hover {
            transform: scale(1.02);
        }

        /* Styling for range input thumb */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #2575fc;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(37, 117, 252, 0.3);
            transition: background 0.3s ease-in-out;
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #2575fc;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(37, 117, 252, 0.3);
            transition: background 0.3s ease-in-out;
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            background: #1a5acb;
        }
        input[type="range"]::-moz-range-thumb:hover {
            background: #1a5acb;
        }

        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-4xl font-extrabold text-center mb-8 text-gray-800">දියුණු QR කේත උත්පාදකය</h1>

        <!-- Input Section -->
        <div class="mb-6">
            <label for="qrInput" class="block text-gray-700 text-base font-medium mb-2">QR කේතය සඳහා දත්ත ඇතුලත් කරන්න:</label>
            <textarea id="qrInput" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-blue-200 transition duration-300 ease-in-out resize-y min-h-[100px] text-gray-800 placeholder-gray-400" placeholder="උදා: https://www.google.com, ඔබගේ පෙළ, හෝ යම් තොරතුරක්..."></textarea>
        </div>

        <!-- Customization Options -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- Foreground Color -->
            <div>
                <label for="fgColor" class="block text-gray-700 text-sm font-medium mb-2">පෙරබිම් වර්ණය:</label>
                <input type="color" id="fgColor" value="#000000" class="w-full h-10 p-1 border border-gray-300 rounded-lg cursor-pointer">
            </div>
            <!-- Background Color -->
            <div>
                <label for="bgColor" class="block text-gray-700 text-sm font-medium mb-2">පසුබිම් වර්ණය:</label>
                <input type="color" id="bgColor" value="#ffffff" class="w-full h-10 p-1 border border-gray-300 rounded-lg cursor-pointer">
            </div>
            <!-- Size -->
            <div class="col-span-1 md:col-span-2">
                <label for="qrSize" class="block text-gray-700 text-sm font-medium mb-2">QR කේත ප්‍රමාණය (<span id="qrSizeValue">256</span>px):</label>
                <input type="range" id="qrSize" min="100" max="500" value="256" step="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
            <!-- Error Correction Level -->
            <div>
                <label for="errorCorrection" class="block text-gray-700 text-sm font-medium mb-2">දෝෂ නිවැරදි කිරීමේ මට්ටම:</label>
                <select id="errorCorrection" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-blue-200 transition duration-300 ease-in-out text-gray-800">
                    <option value="L">L (7%)</option>
                    <option value="M">M (15%)</option>
                    <option value="Q">Q (25%)</option>
                    <option value="H" selected>H (30%)</option>
                </select>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 mb-8">
            <button id="generateBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-4 focus:ring-blue-300">
                QR කේතය සාදන්න
            </button>
            <button id="clearBtn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-4 focus:ring-gray-300">
                පැහැදිලි කරන්න
            </button>
        </div>

        <!-- QR Code Display Section -->
        <div id="qrCodeContainer" class="mt-8 text-center hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">ඔබගේ QR කේතය:</h2>
            <div id="loadingSpinner" class="loader hidden"></div>
            <div id="qrcode" class="bg-gray-100 p-4 rounded-xl inline-block transition duration-300 ease-in-out">
                <!-- QR code will be rendered here by JavaScript -->
            </div>
            <!-- Download Button -->
            <button id="downloadBtn" class="mt-8 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-4 focus:ring-green-300">
                QR කේතය බාගන්න
            </button>
        </div>
    </div>

    <script>
        // Get references to DOM elements
        const qrInput = document.getElementById('qrInput');
        const fgColorInput = document.getElementById('fgColor');
        const bgColorInput = document.getElementById('bgColor');
        const qrSizeInput = document.getElementById('qrSize');
        const qrSizeValueSpan = document.getElementById('qrSizeValue');
        const errorCorrectionSelect = document.getElementById('errorCorrection');
        const generateBtn = document.getElementById('generateBtn');
        const clearBtn = document.getElementById('clearBtn');
        const qrCodeContainer = document.getElementById('qrCodeContainer');
        const qrCodeDiv = document.getElementById('qrcode');
        const downloadBtn = document.getElementById('downloadBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');

        let qrCode = null; // Variable to hold the QRCode.js instance
        let generationTimeout; // To debounce QR code generation

        /**
         * Initializes the QR code generator on window load.
         * Sets up event listeners for inputs and buttons.
         */
        window.onload = function() {
            // Update QR code size value display when slider moves
            qrSizeInput.addEventListener('input', () => {
                qrSizeValueSpan.textContent = qrSizeInput.value;
                debounceGenerateQRCode(); // Regenerate QR on size change
            });

            // Event listeners for input changes to trigger live generation (debounced)
            qrInput.addEventListener('input', debounceGenerateQRCode);
            fgColorInput.addEventListener('input', debounceGenerateQRCode);
            bgColorInput.addEventListener('input', debounceGenerateQRCode);
            errorCorrectionSelect.addEventListener('change', debounceGenerateQRCode);

            // Event listener for the Generate QR Code button (for explicit generation)
            generateBtn.addEventListener('click', generateQRCode);

            // Event listener for the Clear button
            clearBtn.addEventListener('click', clearQRCode);

            // Event listener for the Download QR Code button
            downloadBtn.addEventListener('click', downloadQRCode);

            // Initial generation if there's any default text
            if (qrInput.value.trim() !== "") {
                generateQRCode();
            }
        };

        /**
         * Debounces the QR code generation function to prevent excessive calls
         * when multiple inputs change rapidly (e.g., typing in textarea or dragging slider).
         */
        function debounceGenerateQRCode() {
            clearTimeout(generationTimeout);
            generationTimeout = setTimeout(() => {
                generateQRCode();
            }, 300); // 300ms delay after last input to generate QR
        }

        /**
         * Generates a QR code based on the input text and customization options.
         * Clears any existing QR code before generating a new one.
         * Displays the QR code container and download button.
         */
        function generateQRCode() {
            const data = qrInput.value.trim(); // Get input value and trim whitespace
            const fgColor = fgColorInput.value;
            const bgColor = bgColorInput.value;
            const size = parseInt(qrSizeInput.value);
            const errorCorrection = errorCorrectionSelect.value;

            // Show loading spinner and hide QR code
            qrCodeDiv.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            // Set a small timeout to show the spinner before generation,
            // simulating a slight delay for complex operations.
            setTimeout(() => {
                // Check if input data is empty
                if (data === "") {
                    customAlert("කරුණාකර QR කේතය සඳහා යම් දත්තයක් ඇතුලත් කරන්න.");
                    qrCodeContainer.classList.add('hidden'); // Hide container if no data
                    loadingSpinner.classList.add('hidden');
                    return;
                }

                // Clear previous QR code if exists
                qrCodeDiv.innerHTML = "";
                if (qrCode) {
                    qrCode = null; // Reset the QRCode instance
                }

                try {
                    // Initialize QRCode.js with customization options
                    qrCode = new QRCode(qrCodeDiv, {
                        text: data,
                        width: size,
                        height: size,
                        colorDark: fgColor,
                        colorLight: bgColor,
                        correctLevel: QRCode.CorrectLevel[errorCorrection]
                    });

                    // Show the QR code container and download button
                    qrCodeContainer.classList.remove('hidden');
                    qrCodeDiv.classList.remove('hidden'); // Show QR code
                } catch (error) {
                    customAlert("QR කේතය ජනනය කිරීමේ දෝෂයක් සිදුවිය: " + error.message);
                    qrCodeContainer.classList.add('hidden');
                } finally {
                    loadingSpinner.classList.add('hidden'); // Hide spinner regardless of success/failure
                }
            }, 100); // Short delay to allow spinner to show
        }

        /**
         * Clears the input field and hides the generated QR code.
         */
        function clearQRCode() {
            qrInput.value = '';
            qrCodeDiv.innerHTML = '';
            qrCode = null;
            qrCodeContainer.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
        }

        /**
         * Downloads the generated QR code as a PNG image.
         * Creates a temporary link element and triggers a click to download.
         */
        function downloadQRCode() {
            // Ensure a QR code has been generated
            if (!qrCode) {
                customAlert("කරුණාකර පළමුව QR කේතයක් සාදන්න.");
                return;
            }

            // QRCode.js renders to a canvas. Get the canvas element.
            const canvas = qrCodeDiv.querySelector('canvas');
            if (canvas) {
                // Create a temporary link element
                const link = document.createElement('a');
                link.download = 'qrcode.png'; // Set the download file name
                // Get data URL of the canvas as PNG, providing a fallback for potential errors
                try {
                    link.href = canvas.toDataURL('image/png');
                    document.body.appendChild(link); // Append to body (required for Firefox)
                    link.click(); // Programmatically click the link to trigger download
                    document.body.removeChild(link); // Clean up the temporary link
                } catch (e) {
                    customAlert("QR කේතය බාගත කිරීමේ දෝෂයක් සිදුවිය. සමහරවිට බ්‍රවුසර ආරක්ෂක සීමාවන් නිසා විය හැක.");
                    console.error("Download error:", e);
                }
            } else {
                customAlert("QR කේතය බාගත කිරීමේ දෝෂයක් සිදුවිය. කැන්වසය හමු නොවීය.");
            }
        }

        /**
         * Custom alert function to replace default alert().
         * Displays a modal message to the user.
         * @param {string} message - The message to display in the alert.
         */
        function customAlert(message) {
            const existingModal = document.getElementById('customAlertModal');
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = 'customAlertModal';
            modal.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95 opacity-0" id="alertContent">
                    <div class="text-xl font-bold mb-4 text-gray-800">තොරතුරු</div>
                    <p class="text-gray-700 mb-6">${message}</p>
                    <button id="alertCloseBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-4 focus:ring-blue-300">
                        හරි
                    </button>
                </div>
            `;
            document.body.appendChild(modal);

            // Animate in
            setTimeout(() => {
                document.getElementById('alertContent').classList.remove('scale-95', 'opacity-0');
                document.getElementById('alertContent').classList.add('scale-100', 'opacity-100');
            }, 50);


            document.getElementById('alertCloseBtn').addEventListener('click', () => {
                // Animate out
                document.getElementById('alertContent').classList.remove('scale-100', 'opacity-100');
                document.getElementById('alertContent').classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.remove();
                }, 300); // Match transition duration
            });

            // Close when clicking outside the modal content
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                     // Animate out
                    document.getElementById('alertContent').classList.remove('scale-100', 'opacity-100');
                    document.getElementById('alertContent').classList.add('scale-95', 'opacity-0');
                    setTimeout(() => {
                        modal.remove();
                    }, 300); // Match transition duration
                }
            });
        }
    </script>
</body>
</html>
